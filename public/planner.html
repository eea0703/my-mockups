<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Планировщик задач - Россельхозбанк</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <style>
    :root {
      --primary-color: #0a5f38;
      --primary-light: #e8f5e9;
      --secondary-color: #f8f8f8;
      --warning-color: #ff9800;
      --danger-color: #f44336;
      --info-color: #2196f3;
      --text-color: #333;
      --light-gray: #e0e0e0;
      --bg-color: #f5f5f5;
    }
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    body {
      font-family: 'Roboto', sans-serif;
      color: var(--text-color);
      background-color: var(--bg-color);
      line-height: 1.5;
    }
    .container {
      display: grid;
      grid-template-columns: 250px 1fr;
      min-height: 100vh;
    }
    .sidebar {
      background-color: var(--primary-color);
      color: white;
      padding: 20px 0;
    }
    .logo {
      text-align: center;
      padding: 0 20px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    .nav-menu {
      margin-top: 20px;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    .nav-item {
      padding: 12px 20px;
      cursor: pointer;
      transition: background-color 0.3s;
      display: flex;
      align-items: center;
      font-size: 15px;
    }
    .nav-item:hover, .nav-item.active {
      background-color: rgba(255, 255, 255, 0.1);
    }
    .nav-item i {
      margin-right: 12px;
      width: 20px;
      text-align: center;
      font-size: 16px;
    }
    .nav-item a {
      color: inherit;
      text-decoration: none;
      display: flex;
      align-items: center;
      width: 100%;
      height: 100%;
    }
    .main-content {
      padding: 20px;
      background-color: var(--bg-color);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
    }
    .planner-container {
      overflow-x: auto;
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .planner-header {
      display: flex;
      min-width: 1000px;
    }
    .planner-header .day {
      flex: 1;
      padding: 15px;
      text-align: center;
      font-weight: 500;
      background: #f5f5f5;
      border-right: 1px solid #eee;
    }
    .planner-body {
      min-width: 1000px;
    }
    .employee-row {
      display: flex;
      border-top: 1px solid #eee;
    }
    .employee-cell {
      padding: 15px 10px;
      width: 200px;
      font-weight: 500;
      background: #f9f9f9;
      border-right: 1px solid #eee;
    }
    .day-cell {
      flex: 1;
      min-height: 80px;
      padding: 5px;
      border-right: 1px solid #eee;
      position: relative;
    }
    .task-item {
      background: var(--primary-light);
      border-left: 3px solid var(--primary-color);
      padding: 6px 8px;
      border-radius: 4px;
      font-size: 13px;
      margin-bottom: 4px;
      cursor: pointer;
      word-wrap: break-word;
      position: relative;
    }
    .task-item.overload {
      background: #ffebee;
      border-left-color: var(--danger-color);
    }
    .overload-warning {
      position: absolute;
      top: 2px;
      right: 2px;
      color: var(--danger-color);
      font-size: 10px;
      font-weight: bold;
    }
    .btn {
      padding: 8px 16px;
      border-radius: 4px;
      border: none;
      font-size: 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary {
      background-color: var(--primary-color);
      color: white;
    }
    .btn-primary:hover {
      background-color: #0b4b2c;
    }
    .btn-outline {
      background-color: white;
      border: 1px solid var(--light-gray);
      color: var(--text-color);
    }
    .btn-outline:hover {
      background-color: #f5f5f5;
    }
    /* Модальное окно */
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 8px;
      width: 600px;
      max-width: 90%;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      border-bottom: 1px solid var(--light-gray);
      padding-bottom: 10px;
    }
    .close {
      font-size: 24px;
      cursor: pointer;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-label {
      display: block;
      margin-bottom: 5px;
      font-weight: 500;
      font-size: 14px;
    }
    .form-control {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    .allocation-row {
      display: flex;
      gap: 10px;
      margin-bottom: 8px;
      align-items: center;
    }
    .allocation-day {
      flex: 1;
    }
    .allocation-hours {
      width: 80px;
    }
    .add-day-btn {
      padding: 6px 10px;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .remove-day-btn {
      padding: 6px 10px;
      background: var(--danger-color);
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .total-allocation {
      font-size: 13px;
      color: var(--text-light);
      margin-top: 5px;
    }
    .error {
      color: var(--danger-color);
      font-size: 13px;
      margin-top: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Сайдбар -->
    <div class="sidebar">
      <div class="logo">
        <h3>Россельхозбанк</h3>
        <p>Управление процессами</p>
      </div>
      <div class="nav-menu">
        <div class="nav-item"><a href="index.html"><i class="fa fa-list"></i> Задачи</a></div>
        <div class="nav-item"><a href="processes.html"><i class="fas fa-project-diagram"></i> Процессы</a></div>
        <div class="nav-item"><a href="projects.html"><i class="fas fa-briefcase"></i> Проекты</a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-tasks"></i> Мои задачи</a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-chart-bar"></i> Аналитика</a></div>
        <div class="nav-item"><a href="#"><i class="fas fa-cog"></i> Настройки</a></div>
        <div class="nav-item active"><a href="planner.html"><i class="fas fa-calendar-alt"></i> Планировщик</a></div>
        <div class="nav-item"><a href="competency-matrix.html"><i class="fas fa-th"></i> Матрица компетенций</a></div>
      </div>
    </div>

    <!-- Основной контент -->
    <div class="main-content">
      <div class="header">
        <h2><i class="fas fa-calendar-alt"></i> Планировщик задач</h2>
        <button class="btn btn-primary" onclick="savePlan()">
          <i class="fas fa-save"></i> Сохранить план
        </button>
      </div>
      <div class="planner-container">
        <div class="planner-header" id="planner-header"></div>
        <div class="planner-body" id="planner-body"></div>
      </div>
    </div>
  </div>

  <!-- Модальное окно: распределение задачи -->
  <div class="modal" id="allocation-modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Распределение трудоёмкости</h3>
        <span class="close" onclick="closeModal('allocation-modal')">&times;</span>
      </div>
      <div>
        <p><strong>Задача:</strong> <span id="modal-task-name">-</span></p>
        <p><strong>Исполнитель:</strong> <span id="modal-assignee">-</span></p>
        <p><strong>Объём работ:</strong> <span id="modal-workload">-</span> ч</p>

        <div class="form-group">
          <label>Распределение по дням</label>
          <div id="allocation-days-container">
            <!-- Динамически добавляются строки -->
          </div>
          <button class="add-day-btn" onclick="addAllocationDay()">+ Добавить день</button>
        </div>

        <div class="total-allocation">
          <strong>Всего распределено:</strong> <span id="total-hours">0</span> ч
        </div>
        <div class="error" id="allocation-error"></div>

        <div style="margin-top: 20px; display: flex; gap: 10px;">
          <button class="btn btn-primary" onclick="saveAllocation()">Сохранить</button>
          <button class="btn btn-outline" onclick="closeModal('allocation-modal')">Отмена</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // === МОК-ДАННЫЕ С ОБЪЁМОМ РАБОТ ===
    const mockData = {
      employees: [
        { id: 1, name: 'Петров А.В.', department: 'УОРиПМ' },
        { id: 2, name: 'Сидорова Е.П.', department: 'УОРиПМ' },
        { id: 3, name: 'Иванов И.И.', department: 'УОРиПМ' },
        { id: 4, name: 'Кузнецова О.Л.', department: 'ЭО' },
        { id: 5, name: 'Смирнов Д.М.', department: 'ЭО' },
        { id: 6, name: 'Васильева А.К.', department: 'УПМ' },
        { id: 7, name: 'Николаев П.С.', department: 'УПМ' }
      ],
      tasks: [
        { id: 1, name: 'Актуализация ФРМ ДИТ РБ', assignee: 'Петров А.В.', workload: 8, allocation: [], day: 1 },
        { id: 2, name: 'Обучение нового сотрудника', assignee: 'Петров А.В.', workload: 6, allocation: [], day: 1 },
        { id: 3, name: 'Обновление КПЭ по процессам', assignee: 'Петров А.В.', workload: 4, allocation: [], day: 2 },
        { id: 4, name: 'Внесение изменений в реестр процессов', assignee: 'Петров А.В.', workload: 5, allocation: [], day: 2 },
        { id: 5, name: 'Согласование ЦИЗ ДБД', assignee: 'Петров А.В.', workload: 3, allocation: [], day: 3 },
        { id: 6, name: 'Согласование протокола КСИКР', assignee: 'Сидорова Е.П.', workload: 2, allocation: [], day: 1 },
        { id: 7, name: 'Отправить протокол КУП', assignee: 'Сидорова Е.П.', workload: 1, allocation: [], day: 3 },
        { id: 8, name: 'Сверить данные по переработкам ИНТЕХ', assignee: 'Сидорова Е.П.', workload: 3, allocation: [], day: 5 },
        { id: 9, name: 'Провести совещание с клубом по процессам', assignee: 'Иванов И.И.', workload: 4, allocation: [], day: 2 },
        { id: 10, name: 'Написать СЗ в ДСРП', assignee: 'Иванов И.И.', workload: 5, allocation: [], day: 2 },
        { id: 11, name: 'Проверить драйвера ОРПКП', assignee: 'Иванов И.И.', workload: 3, allocation: [], day: 4 },
        { id: 12, name: 'Актуализация ФРМ ДИТ РБ', assignee: 'Кузнецова О.Л.', workload: 8, allocation: [], day: 1 },
        { id: 13, name: 'Согласование ЦИЗ ДБД', assignee: 'Смирнов Д.М.', workload: 3, allocation: [], day: 3 },
        { id: 14, name: 'Согласовать ФРМ ДМУКП', assignee: 'Васильева А.К.', workload: 4, allocation: [], day: 1 },
        { id: 15, name: 'Проверить логи ПО Агент по ДЗД', assignee: 'Васильева А.К.', workload: 5, allocation: [], day: 1 },
        { id: 16, name: 'Настроить модель расчета НЧ под Р7', assignee: 'Васильева А.К.', workload: 6, allocation: [], day: 1 },
        { id: 17, name: 'Обучить нового сотрудника', assignee: 'Васильева А.К.', workload: 4, allocation: [], day: 4 },
        { id: 18, name: 'Согласование проектной мотивации', assignee: 'Николаев П.С.', workload: 3, allocation: [], day: 2 }
      ]
    };

    const daysToShow = 7;
    const today = new Date();

    // Генерация дней
    function generateDays() {
      const days = [];
      for (let i = 0; i < daysToShow; i++) {
        const date = new Date(today);
        date.setDate(today.getDate() + i);
        days.push({
          num: i + 1,
          label: date.toLocaleDateString('ru-RU', { day: '2-digit', month: 'short' }).replace('.', ''),
          date: date.toISOString().split('T')[0]
        });
      }
      return days;
    }

    // Рендер заголовка
    function renderHeader(days) {
      const header = document.getElementById('planner-header');
      header.innerHTML = '';
      days.forEach(day => {
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.textContent = day.label;
        cell.dataset.day = day.num;
        header.appendChild(cell);
      });
    }

    // Рендер тела
    function renderBody(days) {
      const body = document.getElementById('planner-body');
      body.innerHTML = '';

      mockData.employees.forEach(emp => {
        const row = document.createElement('div');
        row.className = 'employee-row';
        row.dataset.employee = emp.name;

        const nameCell = document.createElement('div');
        nameCell.className = 'employee-cell';
        nameCell.textContent = emp.name;
        row.appendChild(nameCell);

        days.forEach(day => {
          const dayCell = document.createElement('div');
          dayCell.className = 'day-cell';
          dayCell.dataset.day = day.num;
          dayCell.dataset.employee = emp.name;
          dayCell.addEventListener('dragover', e => e.preventDefault());
          dayCell.addEventListener('drop', handleDrop);
          row.appendChild(dayCell);
        });

        body.appendChild(row);
      });

      renderTasks(generateDays());
    }

    // Рендер задач
    function renderTasks(days) {
      const taskCount = {};
      mockData.tasks.forEach(task => {
        const key = `${task.assignee}_${task.day}`;
        taskCount[key] = (taskCount[key] || 0) + 1;
      });

      mockData.tasks.forEach(task => {
        const dayCell = document.querySelector(`.day-cell[data-day="${task.day}"][data-employee="${task.assignee}"]`);
        if (!dayCell) return;

        const taskEl = document.createElement('div');
        taskEl.className = 'task-item';
        taskEl.draggable = true;
        taskEl.dataset.taskId = task.id;
        taskEl.textContent = `${task.name} (${task.workload} ч)`;

        const key = `${task.assignee}_${task.day}`;
        const count = taskCount[key];
        if (count >= 2) {
          taskEl.classList.add('overload');
          taskEl.title = `Конфликт: ${count} задачи в один день!`;
          if (count === 2) {
            const warning = document.createElement('div');
            warning.className = 'overload-warning';
            warning.textContent = '!';
            warning.title = 'Конфликт задач';
            taskEl.appendChild(warning);
          }
        }

        taskEl.addEventListener('click', () => openAllocationModal(task));
        taskEl.addEventListener('dragstart', (e) => {
          e.dataTransfer.setData('text/plain', task.id);
          taskEl.style.opacity = '0.5';
        });
        taskEl.addEventListener('dragend', () => {
          taskEl.style.opacity = '1';
        });

        dayCell.appendChild(taskEl);
      });
    }

    // === МОДАЛЬНОЕ ОКНО РАСПРЕДЕЛЕНИЯ ===
    let currentTask = null;

    function openAllocationModal(task) {
      currentTask = task;
      document.getElementById('modal-task-name').textContent = task.name;
      document.getElementById('modal-assignee').textContent = task.assignee;
      document.getElementById('modal-workload').textContent = task.workload;

      const container = document.getElementById('allocation-days-container');
      container.innerHTML = '';

      // Если уже есть распределение — загружаем
      if (task.allocation && task.allocation.length > 0) {
        task.allocation.forEach(item => {
          addAllocationDay(item.day, item.hours);
        });
      } else {
        addAllocationDay(); // минимум один день
      }

      updateTotalHours();
      document.getElementById('allocation-modal').style.display = 'flex';
    }

    function addAllocationDay(dayNum = '', hours = '') {
      const container = document.getElementById('allocation-days-container');
      const row = document.createElement('div');
      row.className = 'allocation-row';

      const select = document.createElement('select');
      select.className = 'form-control allocation-day';
      select.innerHTML = '<option value="">Выберите день...</option>';
      generateDays().forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.num;
        opt.textContent = d.label;
        if (d.num == dayNum) opt.selected = true;
        select.appendChild(opt);
      });

      const input = document.createElement('input');
      input.type = 'number';
      input.step = '0.5';
      input.min = '0.5';
      input.max = '12';
      input.className = 'form-control allocation-hours';
      input.value = hours || '1.0';

      const removeBtn = document.createElement('button');
      removeBtn.textContent = '×';
      removeBtn.className = 'remove-day-btn';
      removeBtn.onclick = () => {
        container.removeChild(row);
        updateTotalHours();
      };

      row.appendChild(select);
      row.appendChild(input);
      row.appendChild(removeBtn);
      container.appendChild(row);

      input.addEventListener('input', updateTotalHours);
      select.addEventListener('change', updateTotalHours);
    }

    function updateTotalHours() {
      const rows = document.querySelectorAll('#allocation-days-container .allocation-row');
      let total = 0;
      rows.forEach(row => {
        const hours = parseFloat(row.querySelector('.allocation-hours').value) || 0;
        total += hours;
      });
      document.getElementById('total-hours').textContent = total.toFixed(1);

      const error = document.getElementById('allocation-error');
      const workload = currentTask ? currentTask.workload : 0;
      if (total > workload) {
        error.textContent = `Превышение на ${ (total - workload).toFixed(1) } ч`;
      } else if (total < workload) {
        error.textContent = `Не хватает ${ (workload - total).toFixed(1) } ч`;
      } else {
        error.textContent = '';
      }
    }

    function saveAllocation() {
      const rows = document.querySelectorAll('#allocation-days-container .allocation-row');
      const allocation = [];

      let total = 0;
      let valid = true;

      rows.forEach(row => {
        const day = row.querySelector('.allocation-day').value;
        const hours = parseFloat(row.querySelector('.allocation-hours').value) || 0;
        if (day && hours > 0) {
          allocation.push({ day: parseInt(day), hours });
          total += hours;
        }
      });

      const workload = currentTask.workload;
      if (total !== workload) {
        alert(`Сумма часов должна быть равна ${workload} ч`);
        return;
      }

      currentTask.allocation = allocation;
      closeModal('allocation-modal');
      alert('Распределение сохранено');
    }

    function closeModal(id) {
      document.getElementById(id).style.display = 'none';
    }

    // Перетаскивание
    function handleDrop(e) {
      e.preventDefault();
      const taskId = e.dataTransfer.getData('text/plain');
      const task = mockData.tasks.find(t => t.id == taskId);
      if (!task) return;

      const targetDay = e.target.closest('.day-cell').dataset.day;
      const targetEmployee = e.target.closest('.day-cell').dataset.employee;

      task.day = parseInt(targetDay);
      task.assignee = targetEmployee;

      document.getElementById('planner-body').innerHTML = '';
      const days = generateDays();
      renderBody(days);
    }

    // Сохранение плана
    function savePlan() {
      const hasUnallocated = mockData.tasks.some(t => !t.allocation || t.allocation.length === 0);
      if (hasUnallocated) {
        if (!confirm('Некоторые задачи не распределены по часам. Всё равно сохранить?')) {
          return;
        }
      }
      alert('План успешно сохранён');
    }

    // Инициализация
    document.addEventListener('DOMContentLoaded', () => {
      const days = generateDays();
      renderHeader(days);
      renderBody(days);
    });
  </script>
</body>
</html>